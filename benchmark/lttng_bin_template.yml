metadata:
        format: Lava-Test Test Definition 1.0
        name: benchmark-ust-sata
        description: "Perform lttng ust benchmark with the $DISK_PARTITION mounted at /tmp"

params:
        URCU_ARCHIVE: "https://ci.lttng.org/view/Liburcu/job/liburcu_master_portbuild/arch=armhf,build=std,conf=std/lastSuccessfulBuild/artifact/*zip*/archive.zip"
        UST_ARCHIVE: "https://ci.lttng.org/view/LTTng-ust/job/lttng-ust_master_portbuild/arch=armhf,build=std,conf=std,liburcu_version=master/lastSuccessfulBuild/artifact/*zip*/archive.zip"
        # Require lttng-tools with python bindings
        TOOLS_ARCHIVE: "https://ci.lttng.org/view/LTTng-tools/job/lttng-tools_master_portbuild/arch=armhf,babeltrace_version=master,build=std,conf=python-bindings,liburcu_version=master/lastSuccessfulBuild/artifact/*zip*/archive.zip"
        BABELTRACE_ARCHIVE: "https://ci.lttng.org/view/Babeltrace/job/babeltrace_master_portbuild/arch=armhf,build=std,conf=std/26/artifact/*zip*/archive.zip"
        LTTNG_SESSIOND_PATH: /usr/bin
        LTTNG_SESSION_CONFIG_XSD_PATH: /usr/share/xml/lttng/
        LTTNG_CONSUMERD32_BIN: /usr/lib/lttng/libexec/lttng-consumerd
        LTTNG_CONSUMERD64_BIN: /usr/lib/lttng/libexec/lttng-consumerd
        SESSIOND_VERBOSITY: -vvv
        DISK_PARTITION: /dev/sda1
        PYTHONPATH: /usr/lib/python3.4/site-packages/

install:
        git-repos:
                - url: https://github.com/PSRCode/lttng-ust-benchmarks.git
                  destination: benchmarks
                  branch: master
        deps:
                - bsdtar
                - wget
                - python3
        steps:
                - wget --no-check-certificate $URCU_ARCHIVE -O urcu.zip
                - wget --no-check-certificate $UST_ARCHIVE -O ust.zip
                - wget --no-check-certificate $TOOLS_ARCHIVE -O tools.zip
                - wget --no-check-certificate $BABELTRACE_ARCHIVE -O babeltrace.zip
                - for f in *.zip ; do bsdtar --strip-components 2 -xvzf $f -C /usr; done
                - chmod +x /usr/bin/lttng*
                - chmod +x /usr/bin/babeltrace
                - chmod +x /usr/lib/lttng/libexec/lttng-consumerd
                # Mount sata disk and clean it
                - mount $DISK_PARTITION /tmp
                - rm -rf /tmp/*
run:
        steps:
                - export LTTNG_SESSION_CONFIG_XSD_PATH
                - export LTTNG_CONSUMERD32_BIN
                - export LTTNG_CONSUMERD64_BIN
                - export TMPDIR="/tmp"
                - export PYTHONPATH="/tmp"
                - cd benchmarks
                - lava-test-case build-benchmarks --shell "make"
                - lava-test-case run-benchmarks --shell "./benchmarks.py"
                - cd -
