metadata:
        format: Lava-Test Test Definition 1.0
        name: modules-tools
        description: "Test kernel tracing on various kernel"

params:
        URCU_GIT: master
        MODULES_GIT: master
        UST_GIT: master
        TOOLS_GIT: master
        BABELTRACE_GIT: master
        URCU_GIT_URL: https://github.com/urcu/userspace-rcu
        UST_GIT_URL: https://github.com/lttng/lttng-ust
        TOOLS_GIT_URL: https://github.com/lttng/lttng-tools
        BABELTRACE_GIT_URL: https://github.com/efficios/babeltrace

devices:
        - kvm
install:
        git-repos:
                - url: "https://github.com/urcu/userspace-rcu"
                  branch: URCU_GIT
                  destination: userspace-rcu_src
                - url: "https://github.com/lttng/lttng-ust"
                  branch: UST_GIT
                  destination: lttng-ust_src
                - url: "https://github.com/lttng/lttng-tools"
                  branch: TOOLS_GIT
                  destination: lttng-tools_src
                - url: "https://github.com/efficios/babeltrace"
                  branch: BABELTRACE_GIT
                  destination: babeltrace_src
run:
        steps:
                - "lava-test-case install_00 --shell ls -la"
                - "cd userspace-rcu_src"
                - "lava-test-case install_01 --shell ls -la"
                - "lava-test-case install_01 --shell ./bootstrap"
                - "lava-test-case install_02 --shell ./configure"
                - "lava-test-case install_03 --shell make"
                - "lava-test-case install_04 --shell make install"
                - "lava-test-case install_05 --shell ldconfig -v"
                - "cd .."
                - "cd babeltrace_src"
                - "lava-test-case install_08 --shell ./bootstrap"
                - "lava-test-case install_09 --shell ./configure"
                - "lava-test-case install_10 --shell make"
                - "lava-test-case install_11 --shell make install"
                - "lava-test-case install_12 --shell ldconfig -v"
                - "cd .."
                - "cd lttng-ust_src"
                - "lava-test-case install_15 --shell ./bootstrap"
                - "lava-test-case install_16 --shell ./configure"
                - "lava-test-case install_17 --shell make"
                - "lava-test-case install_18 --shell make install"
                - "lava-test-case install_19 --shell ldconfig -v"
                - "cd .."
                - "cd lttng-tools_src"
                - "lava-test-case install_22 --shell ./bootstrap"
                - "lava-test-case install_23 --shell ./configure"
                - "lava-test-case install_24 --shell make"
                - "lava-test-case install_25 --shell make install"
                - "lava-test-case install_26 --shell ldconfig -v"
                - "cd .."
                - "lava-test-case tar --shell tar -xvf /root/4.4.0-rc4.tar -C /lib/modules/"
                - "lava-test-case depmod --shell depmod -a -v"
                - "cd lttng-tools_src/tests"
                - "ls -la"
                - "echo 'regression/tools/streaming/test_high_throughput_limits' > `pwd`/root_regression"
                - "prove --merge -v --exec '' - < `pwd`/root_regression"

